import{d as q,g as X,a as w,u as U,c,H as Q,o as g,b as k,e as m,t as j,f as i,r as E,h as T,i as Z,j as F,k as J,n as A,l as I,V as ee,m as G,F as W,p as te,q as ne,P as oe,s as le,w as se,v as O,x as D,y as H,z as M,A as ae,B as ie,C as ce}from"./vendor.9008bcb1.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))o(l);new MutationObserver(l=>{for(const s of l)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function t(l){const s={};return l.integrity&&(s.integrity=l.integrity),l.referrerpolicy&&(s.referrerPolicy=l.referrerpolicy),l.crossorigin==="use-credentials"?s.credentials="include":l.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(l){if(l.ep)return;l.ep=!0;const s=t(l);fetch(l.href,s)}})();function re(n){let t="";for(let o=0;o<n.length;o+=5)t+=parseInt(n.substr(o,5),2).toString(32);return t}function ue(n){let e="";for(let t=0;t<n.length;t+=1){let o=parseInt(n.substr(t,1),32).toString(2);o.length<5&&(o="00000".slice(o.length)+o),e+=o}return e}function de(n){return`#${re(n)}`}function he(n){return ue(n)}const L={encode:de,decode:he};function pe(){return Math.random().toString(16).slice(2)}function ve(){const n=document.createElement("canvas");if(!n.toDataURL)return!1;n.width=1,n.height=1;try{return n.toDataURL("image/webp").substring(5,15)==="image/webp"}catch{return!1}}function fe(n,e,t){return`${n.substring(0,e)}${t}${n.substring(e+1)}`}const _e="/soulcalc/data";async function ge(n){return fetch(`${_e}/${n.lang}/talents.json?key=${pe()}`).then(e=>e.json())}const S=3.5,V=1,x={scale:S,x:12,y:12,angle:90},z={x:32,y:64},B=q("soulTalents",{state:()=>({loading:!0,error:!1,width:0,height:0,nodes:{},startNodeId:"0",talents:{},bonuses:{},map:{zoom:V,initialPosition:{x:0,y:0},position:{x:0,y:0}},build:"",hoveredId:null,searchQuery:"",webpSupported:!1,lang:"ru",graph:null}),actions:{async load(){this.loading=!0,this.webpSupported=ve(),await this.loadSoulTalents(),this.createGraph(),this.loadBuild(),this.loading=!1},async loadSoulTalents(){try{const{width:n,height:e,nodes:t,talents:o,bonuses:l,startFrom:s}=await ge({lang:"ru"});this.width=n*S+64,this.height=e*S+64,this.talents=o,this.nodes=t,this.bonuses=l,this.startNodeId=s,this.nodes[s].active=!0,this.map.initialPosition.x=this.nodes[s].x*S,this.map.initialPosition.y=this.nodes[s].y*S}catch{this.error=!0}},async loadBuild(){const n=L.decode(window.location.hash.slice(1));if(n.length===0){this.setClearBuild();return}for(let e=0;e<n.length-1;e+=1)n[e]==="1"&&this.activateNodes([`${e+1}`]);this.setBuild(n)},createGraph(){this.graph=X(),this.graph.addNode(this.startNodeId)},activateNodes(n,e=!1){n.forEach(t=>{var o;this.nodes[t].active||(this.nodes[t].active=!0,this.updateBuildCell(t,1),(o=this.graph)==null||o.addNode(t),this.nodes[t].connections.forEach(l=>{var s;(s=this.graph)==null||s.addEdge(t,l)}))}),e&&this.checkActiveNodesConnectionWithCenter(),this.updateBuildUrlHash()},deactivateNodes(n){n.forEach(e=>{var t;this.nodes[e].active=!1,this.updateBuildCell(e,0),(t=this.graph)==null||t.removeNode(e)}),this.checkActiveNodesConnectionWithCenter(),this.updateBuildUrlHash()},resetNodes(){this.activeNodesIds.forEach(n=>{var e;n!==this.startNodeId&&(this.nodes[n].active=!1,(e=this.graph)==null||e.removeNode(n))}),this.setClearBuild(),this.updateBuildUrlHash()},checkActiveNodesConnectionWithCenter(){this.activeNodesIds.forEach(n=>{var e;try{(e=this.graph)==null||e.shortestPath(n,"1")}catch{this.nodes[n].active=!1,this.updateBuildCell(n,0)}})},updateBuildCell(n,e){this.build=fe(this.build,parseInt(n,10)-1,e)},setBuild(n){const e=Object.keys(this.nodes).length;if(n.length<e){const t=new Array(e-n.length).fill(0).join("");n=`${n}${t}`,this.build=n}this.build=n,this.updateBuildUrlHash()},setClearBuild(){this.build=[1,...new Array(Object.keys(this.nodes).length-1).fill(0)].join("")},updateBuildUrlHash(){window.history.replaceState(void 0,"",L.encode(this.build))}},getters:{activeNodesIds(n){return Object.values(n.nodes).reduce((e,{active:t,id:o})=>(t&&o!==this.startNodeId&&e.push(o),e),[])}}}),me={class:"cell-details"},ye={class:"cell-details__title"},Ce={class:"cell-details__description"},$e=["innerHTML"],xe=w({__name:"CellDetails",props:{cell:null,talent:null,rank:null,maxRank:null},setup(n){const e=n,t="\u0412\u0430\u0436\u043D\u043E: \u0418\u0433\u0440\u0443\u0448\u043A\u0443 \u043C\u043E\u0436\u043D\u043E \u043F\u043E\u043B\u0443\u0447\u0438\u0442\u044C \u0442\u043E\u043B\u044C\u043A\u043E \u043E\u0434\u0438\u043D \u0440\u0430\u0437!",{shift:o,alt:l}=U(),s=c(()=>o.value||l.value),a=c(()=>e.rank===0?"1":`${e.rank}`),h=c(()=>e.rank===e.maxRank?"-1":s.value?`${e.maxRank}`:`${e.rank+1}`),u=c(()=>{var p;return(p=e.talent.ranks)==null?void 0:p[a.value]}),y=c(()=>{var p;return(p=e.talent.ranks)==null?void 0:p[h.value]}),C=c(()=>(s.value||!e.cell.active)&&h.value!=="-1"),_=c(()=>{var v;if(e.talent.desc.indexOf(t)!==-1)return`${e.talent.desc.replace(t,"")}<span class="tip-light">${t}</span>`;const p=Q.compile(e.talent.desc),N=Object.keys((v=u.value)!=null?v:{}).reduce(($,b)=>{var P,R;const d=(P=u.value)==null?void 0:P[b],f=(R=y.value)==null?void 0:R[b],Y=d!==f&&C.value?`${d} => ${f}`:d;return $[b]=`<span class="tip-diff">${Y}</span>`,$},{});return p(N)});return(p,r)=>(g(),k("div",me,[m("div",ye,j(e.talent.name),1),m("div",Ce,[m("p",{innerHTML:i(_)},null,8,$e)])]))}});const ke=w({__name:"CellTooltip",props:{container:null,trigger:null,height:null,topSpace:null},setup(n){const e=n,t=E(),o=B(),l=T(e.container),s=T(e.trigger),a=Z(),h=F(),u=c(()=>`scale(${1/o.map.zoom})`),y=c(()=>{const v=r.value?"right":"left",$=_.value?"bottom":"top";return`${v} ${$}`}),C=c(()=>{const v=s.top.value+a.y.value-e.topSpace,$=e.height-v;return{right:h.width.value-s.right.value,bottom:$}}),_=c(()=>C.value.bottom<=l.height.value+32),p=c(()=>!_.value),r=c(()=>C.value.right<=l.width.value+32),N=c(()=>!r.value);return(v,$)=>(g(),k("div",{ref_key:"$el",ref:t,class:A(["cell-tooltip",{"cell-tooltip--top":i(p),"cell-tooltip--left":i(r),"cell-tooltip--bottom":i(_),"cell-tooltip--right":i(N)}]),style:I({transform:i(u),transformOrigin:i(y)})},[J(v.$slots,"default")],6))}});const be=w({__name:"CellConnectors",props:{cell:null},setup(n){const e=n,t=B(),o=e.cell.x*x.scale+x.x,l=e.cell.y*x.scale+x.y,s=e.cell.connections.map(a=>{const{x:h,y:u}=t.nodes[a],y=h*x.scale+x.x,C=u*x.scale+x.y,_=new ee(y-o,C-l);return{id:a,length:_.length(),angle:_.horizontalAngleDeg()+x.angle}});return(a,h)=>(g(!0),k(W,null,G(i(s),u=>(g(),k("div",{key:u.id,class:A(["cell-connector",{"cell-connector--active":i(t).nodes[u.id].active&&e.cell.active}]),style:I({height:`${u.length}px`,transform:`rotate(${u.angle}deg)`})},null,6))),128))}});function Se(n,e){const t=B(),o=T(e);let l=null;return te(n,"panzoomchange",s=>{t.map.position.x=s.detail.x,t.map.position.y=s.detail.y}),ne(()=>{if(n.value){const s=o.width.value/2-(t.map.initialPosition.x+z.x),a=o.height.value/2-(t.map.initialPosition.y+z.y);l=oe(n.value,{contain:"outside",startScale:V,minScale:.5,maxScale:1,cursor:!1,startX:s,startY:a}),t.map.position.x=s,t.map.position.y=a,e==null||e.addEventListener("wheel",h=>{h.shiftKey&&l&&(l==null||l.zoomWithWheel(h),t.map.zoom=l.getScale(),t.map.position=l.getPan())})}}),l}function we(n,e,t){return c(()=>`/soulcalc/data/${e}/icons/${n}.${t?"webp":"png"}`)}function Be(n,e){const t=c(()=>`${e*S}px`),o=c(()=>`${n*S}px`);return{top:t,left:o}}function Ne(n){const e=B(),t=c(()=>Object.values(e.nodes).filter(l=>l.talentId===n.talentId)),o=c(()=>t.value.filter(l=>e.activeNodesIds.includes(l.id)));return{list:t,active:o}}const Ee=["onClick","onContextmenu"],Te=["src","alt"],Ae=w({__name:"Cell",props:{container:null,cell:null,talent:null,height:null,topSpace:null,isHoverActivateModeActive:{type:Boolean},isHoverDeactivateModeActive:{type:Boolean}},emits:["cell:activate","cell:deactivate","group:activate","group:deactivate"],setup(n,{emit:e}){const t=n,o=E(),l=E(),s=le(l),a=B(),h=Be(t.cell.x,t.cell.y),u=Ne(t.cell),y=we(t.talent.icon,a.lang,a.webpSupported);se(s,d=>{d?(a.hoveredId=t.cell.talentId,t.isHoverActivateModeActive?$():t.isHoverDeactivateModeActive&&b()):a.hoveredId===t.cell.talentId&&(a.hoveredId=null)});const C=c(()=>t.cell.connections.some(d=>a.nodes[d].active||a.nodes[d].id==="1")),_=c(()=>s.value&&!(t.isHoverActivateModeActive||t.isHoverDeactivateModeActive)),p=c(()=>!1),r=c(()=>a.hoveredId===t.cell.talentId);function N({shiftKey:d,altKey:f}){$(d||f)}function v({shiftKey:d,altKey:f}){b(d||f)}function $(d=!1){C.value&&(d?e("group:activate",u.list.value.map(({id:f})=>f)):e("cell:activate",t.cell.id))}function b(d=!1){t.cell.id!=="1"&&(d?e("group:deactivate",u.active.value.map(({id:f})=>f)):e("cell:deactivate",t.cell.id))}return(d,f)=>(g(),k("div",{ref_key:"$el",ref:o,class:"cell",style:I({top:i(h).top.value,left:i(h).left.value})},[m("div",{ref_key:"contentEl",ref:l,class:A(["cell__content",{"cell__content--start":t.cell.id==="1","cell__content--active":t.cell.active,"cell__content--uncommon":t.cell.quality===4,"cell__content--rare":t.cell.quality===5}]),onClick:D(N,["left","prevent"]),onContextmenu:[D(v,["right","prevent"]),f[0]||(f[0]=D(()=>{},["prevent"]))]},[m("img",{src:i(y),alt:n.talent.name},null,8,Te),O(` <div class="cell__rank">
        {{ group.active.value.length }}
      </div> `),m("div",{class:A(["cell__frame",{"cell__frame--search":i(p),"cell__frame--group":i(r)}])},null,2)],42,Ee),H(be,{cell:t.cell},null,8,["cell"]),i(_)?(g(),M(ke,{key:0,trigger:o.value,height:t.height,"top-space":t.topSpace,container:t.container},{default:ae(()=>[H(xe,{cell:t.cell,talent:n.talent,rank:i(u).active.value.length,"max-rank":i(u).list.value.length},null,8,["cell","talent","rank","max-rank"])]),_:1},8,["trigger","height","top-space","container"])):O("v-if",!0)],4))}});const Ie=w({__name:"Map",props:{container:null},setup(n){const e=n,t=E(),o=B();Se(t,e.container);const l=F(),s=T(t),{KeyE:a,KeyQ:h}=U();function u(r){o.activateNodes([r])}function y(r){o.deactivateNodes([r])}function C(r){o.activateNodes(r,!0)}function _(r){o.deactivateNodes(r)}function p(r){a.value&&!o.nodes[r].active?u(r):h.value&&y(r)}return(r,N)=>(g(),k("div",{ref_key:"$el",ref:t,class:"map",style:I({width:`${i(o).width}px`,height:`${i(o).height}px`})},[(g(!0),k(W,null,G(i(o).nodes,v=>(g(),M(Ae,{key:v.id,cell:v,talent:i(o).talents[v.talentId],height:i(l).height.value,"top-space":i(s).top.value,"is-hover-activate-mode-active":i(a),"is-hover-deactivate-mode-active":i(h),container:e.container,onHoverToogle:p,"onCell:activate":u,"onCell:deactivate":y,"onGroup:activate":C,"onGroup:deactivate":_},null,8,["cell","talent","height","top-space","is-hover-activate-mode-active","is-hover-deactivate-mode-active","container"]))),128))],4))}});const De={class:"calculator__stats"},Oe=m("p",null,"\u041A\u0430\u043B\u044C\u043A\u0443\u043B\u044F\u0442\u043E\u0440 \u0442\u0430\u043B\u0430\u043D\u0442\u043E\u0432 \u0438\u0441\u043A\u0440\u044B",-1),He=w({__name:"Calculator",setup(n){const e=B();e.load();const t=E(),o=c(()=>!e.loading&&!e.error);function l(){e.resetNodes()}return(s,a)=>(g(),k("div",{ref_key:"$el",ref:t,class:"calculator"},[m("div",De,[Oe,m("p",null,"\u0412\u044B\u0431\u0440\u0430\u043D\u043E: "+j(i(e).activeNodesIds.length),1),m("p",null,[m("button",{onClick:l}," \u0421\u0431\u0440\u043E\u0441\u0438\u0442\u044C ")])]),i(o)?(g(),M(Ie,{key:0,container:t.value},null,8,["container"])):O("v-if",!0)],512))}});const Me={class:"app"},Pe=w({__name:"App",setup(n){return(e,t)=>(g(),k("div",Me,[H(He)]))}});const K=ie(Pe),Re=ce();K.use(Re);K.mount("#aopro-spark-talents-calc");
