var ie=Object.defineProperty;var ce=(s,e,t)=>e in s?ie(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var j=(s,e,t)=>(ce(s,typeof e!="symbol"?e+"":e,t),t);import{s as re,d as ue,a as $,u as X,c as h,H as Y,o as p,b as f,e as g,t as R,f as J,g as i,h as E,r as I,i as L,j as Z,k as de,n as P,l as U,V as he,m as F,F as z,p as pe,q as _e,P as ve,v as ee,w as te,x as se,y as N,z as T,A as H,B as ne,C as fe,D as ge,E as me,G as ye,I as be,J as xe}from"./vendor.0fbfe0b0.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function t(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerpolicy&&(a.referrerPolicy=o.referrerpolicy),o.crossorigin==="use-credentials"?a.credentials="include":o.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(o){if(o.ep)return;o.ep=!0;const a=t(o);fetch(o.href,a)}})();function we(s){let t="";for(let n=0;n<s.length;n+=5)t+=parseInt(s.substr(n,5),2).toString(32);return t}function $e(s){let e="";for(let t=0;t<s.length;t+=1){let n=parseInt(s.substr(t,1),32).toString(2);n.length<5&&(n="00000".slice(n.length)+n),e+=n}return e}function Ce(s){return`#${we(s)}`}function ke(s){return $e(s)}const G={encode:Ce,decode:ke};function Se(){return Math.random().toString(16).slice(2)}function Be(){const s=document.createElement("canvas");if(!s.toDataURL)return!1;s.width=1,s.height=1;try{return s.toDataURL("image/webp").substring(5,15)==="image/webp"}catch{return!1}}function Te(s,e,t){return`${s.substring(0,e)}${t}${s.substring(e+1)}`}function Ee(s){return Object.keys(s[0]).reduce((e,t)=>{const n=re(s.map(o=>{var a;return(a=o==null?void 0:o[t])!=null?a:0}));return e[t]=`<span class="tip-summary">${n}</span>`,e},{})}const Ae="/soulcalc/data";async function Ie(s){return fetch(`${Ae}/${s.lang}/talents.json?key=${Se()}`).then(e=>e.json())}const D=0,Q=s=>(s+1>>>1)-1,O=s=>(s<<1)+1,M=s=>s+1<<1;class De{constructor(e){j(this,"heap",[]);j(this,"comparator");this.heap=[],this.comparator=e}reset(){this.heap=[]}get size(){return this.heap.length}get isEmpty(){return this.size===0}peek(){return this.heap[D]}push(...e){return e.forEach(t=>{this.heap.push(t),this.siftUp()}),this.size}pop(){const e=this.peek(),t=this.size-1;return t>D&&this.swap(D,t),this.heap.pop(),this.siftDown(),e}replace(e){const t=this.peek();return this.heap[D]=e,this.siftDown(),t}greater(e,t){return this.comparator(this.heap[e],this.heap[t])}swap(e,t){[this.heap[e],this.heap[t]]=[this.heap[t],this.heap[e]]}siftUp(){let e=this.size-1;for(;e>D&&this.greater(e,Q(e));)this.swap(e,Q(e)),e=Q(e)}siftDown(){let e=D;const t=()=>O(e)<this.size&&this.greater(O(e),e)||M(e)<this.size&&this.greater(M(e),e);for(;t();){const n=M(e)<this.size&&this.greater(M(e),O(e))?M(e):O(e);this.swap(e,n),e=n}}}const A=3.5,oe=1,S={scale:A,x:12,y:12,angle:90},K={x:32,y:64},C=ue("soulTalents",{state:()=>({loading:!0,error:!1,width:0,height:0,nodes:{},startNodeId:"0",talents:{},bonuses:[],map:{zoom:oe,initialPosition:{x:0,y:0},position:{x:0,y:0}},build:"",highlightIds:[],searchQuery:"",webpSupported:!1,lang:"ru",queue:null}),actions:{async load(){this.loading=!0,this.webpSupported=Be(),await this.loadSoulTalents(),this.createQueue(),this.loadBuild(),this.loading=!1},async loadSoulTalents(){try{const{width:s,height:e,nodes:t,talents:n,bonuses:o,startFrom:a}=await Ie({lang:"ru"});this.width=s*A+64,this.height=e*A+64,this.talents=n,this.nodes=t,this.bonuses=Object.values(o),this.startNodeId=a,this.nodes[a].active=!0,this.map.initialPosition.x=this.nodes[a].x*A,this.map.initialPosition.y=this.nodes[a].y*A}catch{this.error=!0}},async loadBuild(){const s=G.decode(window.location.hash.slice(1));if(s.length===0){this.setClearBuild();return}for(let e=0;e<s.length-1;e+=1)this.nodes[`${e+1}`].active=s[e]==="1";this.setBuild(s)},createQueue(){this.queue=new De((s,e)=>s[1]>e[1])},activateNodes(s){s.forEach(e=>{this.nodes[e].active||this.nodes[e].connections.every(t=>this.nodes[t].active?(this.nodes[e].active=!0,this.updateBuildCell(e,!0),!1):!0)}),this.updateBuildUrlHash()},deactivateNodes(s,e=!0){s.forEach(t=>{if(t===this.startNodeId)return;const n=[t],o=this.nodes[t].connections.filter(a=>this.nodes[a].active);o.length>1&&o.forEach(a=>{n.push(...this.trackRoute(a,t))}),n.forEach(a=>{this.nodes[a].active=!1,this.updateBuildCell(a,!1)})}),e&&this.updateBuildUrlHash()},deactivateTalents(s){s.forEach(e=>{const t=this.activeNodes.filter(n=>n.talentId===e).map(({id:n})=>n);this.deactivateNodes(t,!1)}),this.updateBuildUrlHash()},resetNodes(){this.activeNodesIds.forEach(s=>{s!==this.startNodeId&&(this.nodes[s].active=!1)}),this.setClearBuild(),this.updateBuildUrlHash()},trackRoute(s,e){var n,o,a,l;(n=this.queue)==null||n.reset(),(o=this.queue)==null||o.push([s,"0"]);const t=[];for(t.push(e);!((a=this.queue)!=null&&a.isEmpty);){const c=(l=this.queue)==null?void 0:l.pop()[0];if(c===this.startNodeId)return[];t.push(c);const r=[];this.nodes[c].connections.forEach(u=>{!t.includes(u)&&this.nodes[u].active&&(t.push(u),r.push(u))}),r.forEach(u=>{var _;(_=this.queue)==null||_.push([u,r.length>1?"1":"0"])})}return t},updateBuildCell(s,e){this.build=Te(this.build,parseInt(s,10)-1,e?"1":"0")},setBuild(s){const e=Object.keys(this.nodes).length;if(s.length<e){const t=new Array(e-s.length).fill(0).join("");s=`${s}${t}`,this.build=s}this.build=s,this.updateBuildUrlHash()},setClearBuild(){this.build=[1,...new Array(Object.keys(this.nodes).length-1).fill(0)].join("")},updateBuildUrlHash(){window.history.replaceState(void 0,"",G.encode(this.build))}},getters:{activeNodes(s){return Object.values(s.nodes).filter(({active:e})=>e)},activeNodesIds(){return this.activeNodes.map(({id:s})=>s)}}}),Ne={class:"cell-details"},He={class:"cell-details__title"},Me={class:"cell-details__rank"},Le={key:0,class:"tip-green"},ze={class:"cell-details__description"},Pe=["innerHTML"],Oe=$({__name:"CellDetails",props:{cell:null,talent:null,rank:null,maxRank:null},setup(s){const e=s,{shift:t,alt:n}=X(),o=h(()=>t.value||n.value),a=h(()=>e.rank===0?"1":`${e.rank}`),l=h(()=>e.rank===e.maxRank?"-1":o.value?`${e.maxRank}`:`${e.rank+1}`),c=h(()=>{var d;return(d=e.talent.ranks)==null?void 0:d[a.value]}),r=h(()=>{var d;return(d=e.talent.ranks)==null?void 0:d[l.value]}),u=h(()=>(o.value||!e.cell.active)&&l.value!=="-1"),_=h(()=>{var k;const d=Y.compile(e.talent.desc),v=Object.keys((k=c.value)!=null?k:{}).reduce((m,x)=>{var q,V;const B=(q=c.value)==null?void 0:q[x],y=(V=r.value)==null?void 0:V[x],le=B!==y&&u.value?`${B} => ${y}`:B;return m[x]=`<span class="tip-diff">${le}</span>`,m},{});return d(v)});return(d,b)=>(p(),f("div",Ne,[g("div",He,R(e.talent.name),1),g("div",Me,[J(" \u0420\u0430\u043D\u0433: "+R(i(a))+" ",1),i(u)&&i(l)!=="1"?(p(),f("span",Le," => "+R(i(l)),1)):E("v-if",!0)]),g("div",ze,[g("p",{innerHTML:i(_)},null,8,Pe)])]))}});const Re=$({__name:"CellTooltip",props:{container:null,trigger:null,height:null,topSpace:null},setup(s){const e=s,t=I(),n=C(),o=L(t),a=L(e.trigger),l=L(e.container),c=Z(),r=h(()=>1/n.map.zoom),u=h(()=>{const m=v.value?"right":"left",x=d.value?"bottom":"top";return`${m} ${x}`}),_=h(()=>{const m=o.top.value-l.top.value,x=e.height-m,B=c.width.value-a.right.value;return{top:m,right:B,bottom:x}}),d=h(()=>_.value.bottom<=l.height.value+32),b=h(()=>!d.value),v=h(()=>_.value.right<=l.width.value+32),k=h(()=>!v.value);return(m,x)=>(p(),f("div",{ref_key:"$el",ref:t,class:P(["cell-tooltip",{"cell-tooltip--top":i(b),"cell-tooltip--left":i(v),"cell-tooltip--bottom":i(d),"cell-tooltip--right":i(k)}]),style:U({scale:i(r),transformOrigin:i(u)})},[de(m.$slots,"default")],6))}});const Fe=$({__name:"CellConnectors",props:{cell:null},setup(s){const e=s,t=C(),n=e.cell.x*S.scale+S.x,o=e.cell.y*S.scale+S.y,a=e.cell.connections.map(l=>{const{x:c,y:r}=t.nodes[l],u=c*S.scale+S.x,_=r*S.scale+S.y,d=new he(u-n,_-o);return{id:l,length:d.length(),angle:d.horizontalAngleDeg()+S.angle}});return(l,c)=>(p(!0),f(z,null,F(i(a),r=>(p(),f("div",{key:r.id,class:P(["cell-connector",{"cell-connector--active":i(t).nodes[r.id].active&&e.cell.active}]),style:U({height:`${r.length}px`,transform:`rotate(${r.angle}deg)`})},null,6))),128))}});function Ue(s,e){const t=C(),n=L(e);let o=null;return pe(s,"panzoomchange",a=>{t.map.position.x=a.detail.x,t.map.position.y=a.detail.y}),_e(()=>{if(s.value){const a=n.width.value/2-(t.map.initialPosition.x+K.x),l=n.height.value/2-(t.map.initialPosition.y+K.y);o=ve(s.value,{contain:"outside",startScale:oe,minScale:.1,maxScale:1,cursor:!1,startX:a,startY:l,step:window.screen.width>969?.4:.1,excludeClass:["cell"]}),t.map.position.x=a,t.map.position.y=l,e==null||e.addEventListener("wheel",c=>{if(o){const{x:r,y:u,scale:_}=o.zoomWithWheel(c);t.map.zoom=_,t.map.position.x=r,t.map.position.y=u}})}}),o}function je(s,e,t){return h(()=>`/soulcalc/data/${e}/icons/${s}.${t?"webp":"png"}`)}function Qe(s,e){const t=h(()=>`${e*A}px`),n=h(()=>`${s*A}px`);return{top:t,left:n}}function qe(s){const e=C(),t=h(()=>Object.values(e.nodes).filter(o=>o.talentId===s.talentId)),n=h(()=>t.value.filter(o=>e.activeNodesIds.includes(o.id)));return{list:t,active:n}}const Ve=["onClick","onContextmenu"],Ge=["src","alt"],Ke=$({__name:"Cell",props:{container:null,cell:null,talent:null,height:null,topSpace:null,isHoverActivateModeActive:{type:Boolean},isHoverDeactivateModeActive:{type:Boolean}},emits:["cell:activate","cell:deactivate","group:activate","group:deactivate"],setup(s,{emit:e}){const t=s,n=I(),o=I(),a=ee(o),l=C(),c=qe(t.cell),r=Qe(t.cell.x,t.cell.y),u=je(t.talent.icon,l.lang,l.webpSupported);te(a,y=>{y?(l.highlightIds=[t.cell.talentId],t.isHoverActivateModeActive?x():t.isHoverDeactivateModeActive&&B()):l.highlightIds.includes(t.cell.talentId)&&(l.highlightIds=[])}),se(n,m,{modifiers:{prevent:!0}});const _=h(()=>t.cell.connections.some(y=>l.nodes[y].active||l.nodes[y].id==="1")),d=h(()=>a.value&&!(t.isHoverActivateModeActive||t.isHoverDeactivateModeActive)),b=h(()=>l.searchQuery.length>=3&&new RegExp(l.searchQuery,"i").test(t.talent.name)&&!(t.isHoverActivateModeActive||t.isHoverDeactivateModeActive)),v=h(()=>l.highlightIds.includes(t.cell.talentId)&&!(t.isHoverActivateModeActive||t.isHoverDeactivateModeActive));function k({shiftKey:y,altKey:w}){x(y||w)}function m({shiftKey:y,altKey:w}){B(y||w)}function x(y=!1){_.value&&(y?e("group:activate",c.list.value.map(({id:w})=>w)):e("cell:activate",t.cell.id))}function B(y=!1){t.cell.id!=="1"&&(y?e("group:deactivate",c.active.value.map(({id:w})=>w)):e("cell:deactivate",t.cell.id))}return(y,w)=>(p(),f("div",{ref_key:"$el",ref:n,class:"cell",style:U({top:i(r).top.value,left:i(r).left.value})},[g("div",{ref_key:"contentEl",ref:o,class:P(["cell__content",{"cell__content--start":t.cell.id==="1","cell__content--active":t.cell.active,"cell__content--uncommon":t.cell.quality===4,"cell__content--rare":t.cell.quality===5}]),onClick:N(k,["left","prevent"]),onContextmenu:[N(m,["right","prevent"]),w[0]||(w[0]=N(()=>{},["prevent"]))]},[g("img",{src:i(u),alt:s.talent.name},null,8,Ge),g("div",{class:P(["cell__frame",{"cell__frame--search":i(b),"cell__frame--group":i(v)}])},null,2)],42,Ve),T(Fe,{cell:t.cell},null,8,["cell"]),i(d)?(p(),H(Re,{key:0,trigger:n.value,height:t.height,"top-space":t.topSpace,container:t.container},{default:ne(()=>[T(Oe,{cell:t.cell,talent:t.talent,rank:i(c).active.value.length,"max-rank":i(c).list.value.length},null,8,["cell","talent","rank","max-rank"])]),_:1},8,["trigger","height","top-space","container"])):E("v-if",!0)],4))}});const We=$({__name:"CalculatorMap",props:{container:null},setup(s){const e=s,t=I(),n=C();Ue(t,e.container);const o=Z(),a=L(t),{KeyE:l,KeyQ:c}=X();function r(v){n.activateNodes([v])}function u(v){n.deactivateNodes([v])}function _(v){n.activateNodes(v)}function d(v){n.deactivateNodes(v)}function b(v){l.value&&!n.nodes[v].active?r(v):c.value&&u(v)}return(v,k)=>(p(),f("div",{ref_key:"$el",ref:t,class:"calculator-map",style:U({width:`${i(n).width}px`,height:`${i(n).height}px`})},[(p(!0),f(z,null,F(i(n).nodes,m=>(p(),H(Ke,{key:m.id,cell:m,talent:i(n).talents[m.talentId],height:i(o).height.value,"top-space":i(a).top.value,"is-hover-activate-mode-active":i(l),"is-hover-deactivate-mode-active":i(c),container:e.container,onHoverToogle:b,"onCell:activate":r,"onCell:deactivate":u,"onGroup:activate":_,"onGroup:deactivate":d},null,8,["cell","talent","height","top-space","is-hover-activate-mode-active","is-hover-deactivate-mode-active","container"]))),128))],4))}});const Xe={xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 320 512"},Ye=g("path",{d:"M310.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L160 210.7 54.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L114.7 256 9.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L160 301.3l105.4 105.3c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L205.3 256l105.3-105.4z"},null,-1);function Je(s,e){return p(),f("svg",Xe,[E("! Font Awesome Pro 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc."),Ye])}const Ze={render:Je},et={class:"calculator-search"},tt=$({__name:"CalculatorSearch",setup(s){const e=C();function t(){e.searchQuery=""}return(n,o)=>(p(),f("div",et,[fe(g("input",{"onUpdate:modelValue":o[0]||(o[0]=a=>i(e).searchQuery=a),type:"text",placeholder:"\u041F\u043E\u0438\u0441\u043A \u043F\u043E \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044E",class:"calculator-search__field"},null,512),[[ge,i(e).searchQuery]]),i(e).searchQuery.length?(p(),f("button",{key:0,class:"calculator-search__clear",onClick:t},[T(i(Ze))])):E("v-if",!0)]))}});const st=["innerHTML"],W=$({__name:"CalculatorBonuse",props:{bonuse:null},setup(s){const e=s,t=I(),n=I(!1),o=ee(t),a=C();te(o,_=>{_?a.highlightIds=e.bonuse.talents:(n.value=!1,a.highlightIds=[])}),se(t,u,{delay:1500});function l(_){_.buttons&&(n.value=!0)}function c(){n.value=!0}function r(){n.value=!1}function u(){a.highlightIds=[],n.value=!1,a.deactivateTalents(e.bonuse.talents)}return(_,d)=>(p(),f("div",{ref_key:"$el",ref:t,class:P(["calculator-bonuse",{"calculator-bonuse--mousedown":n.value}]),onMousedown:l,onClick:d[0]||(d[0]=N(()=>{},["left","prevent"])),onContextmenu:[d[1]||(d[1]=N(()=>{},["right","prevent"])),d[2]||(d[2]=N(()=>{},["prevent"]))],onTouchstart:c,onTouchend:r,innerHTML:e.bonuse.text},null,42,st))}});const nt={class:"calculator-bonuses"},ot=g("div",{class:"calculator-bonuses__title"}," \u042D\u0444\u0444\u0435\u043A\u0442\u044B ",-1),at={key:1,class:"calculator-bonuses__placeholder"},lt=g("div",{class:"calculator-bonuses__title"}," \u0421\u043F\u0443\u0442\u043D\u0438\u043A\u0438 ",-1),it=$({__name:"CalculatorBonuses",setup(s){const e=C(),t=h(()=>me(e.activeNodes,"talentId")),n=e.bonuses.findIndex(({isToy:l})=>l),o=h(()=>{var c,r;return((r=(c=e.bonuses[n])==null?void 0:c.talents)!=null?r:[]).reduce((u,_)=>{var d;if(t.value[_]){const b=(d=e.talents[_])==null?void 0:d.name;b&&u.push({text:b,talents:[_]})}return u},[])}),a=h(()=>e.bonuses.reduce((l,c)=>{if(c.talents.every(b=>t.value[b]===void 0)||c.isToy)return l;const u=c.talents.map(b=>{var k,m;const v=t.value[b];return(m=(k=e.talents[b].ranks)==null?void 0:k[v])!=null?m:{}}),_=Y.compile(c.desc),d=Ee(u);return l.push({text:_(d),talents:c.talents}),l},[]));return(l,c)=>(p(),f("div",nt,[ot,i(a).length?(p(!0),f(z,{key:0},F(i(a),(r,u)=>(p(),H(W,{key:u,bonuse:r},null,8,["bonuse"]))),128)):(p(),f("div",at," \u041D\u0435\u0442 \u044D\u0444\u0444\u0435\u043A\u0442\u043E\u0432 \u043E\u0442 \u0432\u0437\u044F\u0442\u044B\u0445 \u0432\u0435\u0445 ")),i(o).length?(p(),f(z,{key:2},[lt,(p(!0),f(z,null,F(i(o),(r,u)=>(p(),H(W,{key:u,bonuse:r},null,8,["bonuse"]))),128))],64)):E("v-if",!0)]))}});const ct={xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 448 512"},rt=g("path",{d:"M0 96c0-17.7 14.3-32 32-32h384c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zm0 160c0-17.7 14.3-32 32-32h384c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zm448 160c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32h384c17.7 0 32 14.3 32 32z"},null,-1);function ut(s,e){return p(),f("svg",ct,[E("! Font Awesome Pro 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc."),rt])}const dt={render:ut};const ht={class:"calculator-sidebar"},pt={class:"calculator-sidebar__header"},_t=g("div",{class:"calculator-sidebar__header-text"}," \u041A\u0430\u043B\u044C\u043A\u0443\u043B\u044F\u0442\u043E\u0440 \u0418\u0441\u043A\u0440\u044B ",-1),vt={class:"calculator-sidebar__footer"},ft={class:"calculator-sidebar__consumed"},gt=$({__name:"CalculatorSidebar",setup(s){const e=C();function t(){e.resetNodes()}return(n,o)=>(p(),f("div",ht,[g("div",pt,[_t,T(i(dt),{class:"calculator-sidebar__header-icon"})]),T(tt),T(i(ye),{class:"calculator-sidebar__content"},{default:ne(()=>[T(it)]),_:1}),g("div",vt,[g("div",ft,[J(" \u041E\u0447\u043A\u043E\u0432 \u0432\u043B\u043E\u0436\u0435\u043D\u043E: "),g("b",null,R(i(e).activeNodesIds.length),1)]),g("button",{class:"calculator-sidebar__reset",onClick:t}," \u0421\u0431\u0440\u043E\u0441\u0438\u0442\u044C \u0432\u0441\u0435 ")])]))}});const mt={class:"calculator"},yt={class:"calculator__sidebar"},bt=g("div",{id:"tooltip-area",class:"calculator__tooltips"},null,-1),xt=$({__name:"Calculator",setup(s){const e=C();e.load();const t=I(),n=h(()=>!e.loading&&!e.error);return(o,a)=>(p(),f("div",mt,[g("div",{ref_key:"container",ref:t,class:"calculator__container"},[i(n)?(p(),H(We,{key:0,container:t.value},null,8,["container"])):E("v-if",!0)],512),g("div",yt,[i(n)?(p(),H(gt,{key:0})):E("v-if",!0)]),bt]))}});const wt={class:"app"},$t=$({__name:"App",setup(s){return(e,t)=>(p(),f("div",wt,[T(xt)]))}});const ae=be($t),Ct=xe();ae.use(Ct);ae.mount("#aopro-spark-talents-calc");
